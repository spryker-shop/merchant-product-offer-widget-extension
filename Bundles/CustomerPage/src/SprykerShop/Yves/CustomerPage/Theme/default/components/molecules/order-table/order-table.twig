{% extends model('component') %}

{% define config = {
    name: 'order-table',
} %}

{% define data = {
    orders: required,
    orderSearchForm: null,
    isOrderSearchEnabled: false,
    isOrderSearchOrderItemsVisible: true,
} %}

{% block body %}
    {% set orderByValue = data.orderSearchForm.orderBy.vars.value %}
    {% set orderDirectionValue = data.orderSearchForm.orderDirection.vars.value %}

    {{ form_row(data.orderSearchForm.orderBy, {
        attr: {
            class: data.jsPrefix ~ 'orderBy-target',
        }}) }}
    {{ form_row(data.orderSearchForm.orderDirection, {
        attr: {
            class: data.jsPrefix ~ 'orderDirection-target',
        }}) }}
    <table class="table table--expand">
        <thead>
            <tr>
                <th class="{{ data.jsPrefix }}orderBy-trigger {{ data.jsPrefix }}orderDirection-trigger"
                    set-value="orderReference"
                    set-value-direction="{{ (orderDirectionValue == 'ASC') ? 'DESC' : 'ASC' }}">
                    {{ 'customer.order.reference' | trans }}

                    {% set iconName = 'sort-none' %}
                    {% if (orderByValue == 'orderReference') %}
                        {% set iconName = (orderDirectionValue == 'ASC') ? 'sort-asc' : 'sort-desc' %}
                    {% endif %}

                    {% include atom('icon') with {
                        modifiers: ['small'],
                        data: {
                            name: iconName,
                        }
                    } only %}
                </th>
                <th class="{{ data.jsPrefix }}orderBy-trigger {{ data.jsPrefix }}orderDirection-trigger"
                    set-value="date"
                    set-value-direction="{{ (orderDirectionValue == 'ASC') ? 'DESC' : 'ASC' }}">
                    {{ 'customer.order.date' | trans }}

                    {% set iconName = 'sort-none' %}
                    {% if (orderByValue == 'date') %}
                        {% set iconName = (orderDirectionValue == 'ASC') ? 'sort-asc' : 'sort-desc' %}
                    {% endif %}

                    {% include atom('icon') with {
                        modifiers: ['small'],
                        data: {
                            name: iconName,
                        }
                    } only %}
                </th>
                {% if data.isOrderSearchEnabled and data.isOrderSearchOrderItemsVisible %}
                    <th>{{ 'customer.order.number_of_items' | trans }}</th>
                {% endif %}
                <th>{{ 'customer.order.total' | trans }}</th>
                <th>{{ 'customer.table.actions' | trans }}</th>
            </tr>
        </thead>
        <tbody>
            {% if data.orders is empty %}
                <tr>
                    <td colspan="100">{{ 'customer.account.no_order' | trans }}</td>
                </tr>
            {% endif %}

            {% for order in data.orders %}
                <tr>
                    <td>{{ order.orderReference }}</td>
                    <td>{{ date(order.createdAt) | formatDateTime }}</td>
                    {% if data.isOrderSearchEnabled and data.isOrderSearchOrderItemsVisible %}
                        <td>{{ order.items.count }}</td>
                    {% endif %}
                    <td>{{ order.totals.grandTotal | default(0) | money(true, order.currencyIsoCode) }}</td>
                    <td>
                        <ul class="menu menu--inline">
                            <li class="menu__item">
                                <a href="{{ path('customer/order/details', {'id': order.idSalesOrder}) }}">
                                    {{ 'customer.order.view_order' | trans }}
                                </a>
                            </li>
                            {% if widgetExists('CustomerReorderWidgetPlugin') %}
                                <li class="menu__item">
                                    {{ widgetBlock('CustomerReorderWidgetPlugin', 'reorderAction', order) }} {# @deprecated Use molecule('customer-reorder-link', 'CustomerReorderWidget') instead. #}
                                </li>
                            {% else %}
                                {% include molecule('customer-reorder-link', 'CustomerReorderWidget') with {
                                    data: {
                                        idSalesOrder: order.idSalesOrder
                                    }
                                } only %}
                            {% endif %}
                        </ul>
                    </td>
                </tr>
                {% if data.isOrderSearchEnabled and data.isOrderSearchOrderItemsVisible %}
                    <tr>
                        <td colspan="100">
                            {% include molecule('order-table-products', 'CustomerPage') with {
                                data: {
                                    items: order.items,
                                },
                            } only %}
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>


    {% include molecule('form-value-setter', 'CustomerPage') with {
        attributes: {
            'trigger-class': data.jsPrefix ~ 'orderBy-trigger',
            'target-class': data.jsPrefix ~ 'orderBy-target',
        },
    } only %}

    {% include molecule('form-value-setter', 'CustomerPage') with {
        attributes: {
            'trigger-class': data.jsPrefix ~ 'orderDirection-trigger',
            'target-class': data.jsPrefix ~ 'orderDirection-target',
            'value-field': 'set-value-direction',
        },
    } only %}
{% endblock %}
